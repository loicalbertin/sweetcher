name: Tests

on: [push, pull_request]

jobs:

  tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
    - name: Download deps
      run: |
        pwd; ls -1a
        wget --output-document=gotestsum.tgz https://github.com/gotestyourself/gotestsum/releases/download/v1.11.0/gotestsum_1.11.0_linux_amd64.tar.gz
        tar xzf gotestsum.tgz gotestsum
        rm -f gotestsum.tgz
    - name: Test
      uses: docker://golang:1
      with:
        args: /bin/bash -c "pwd; ls -1a ; ./gotestsum --jsonfile tests-reports.json  -- -count=1 -coverprofile coverage-sonar.out -coverpkg=./... $(go list ./...)"
      env:
        XDG_CACHE_HOME: /tmp/.cache
        HOME: /tmp/buildhome
    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      if: ${{ ! github.event.pull_request.head.repo.fork }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}